== Introduction
The following framework consists of a series of automation tools, which allow you to run interoperability tests on a connector in Anypoint Studio. The data used by these tests  generates using not only the connectors code, but also DevKit output files, in particular the schema and editors file.

All cases described in the https://docs.google.com/a/mulesoft.com/document/d/1HIiE8akbyr-jdfS-XJUZo45JL0J6G2OmQY_jO4rEkz4[Interoperability Test Guidelines] should be considered depending on the connector’s nature. This means, all the applicable test cases detailed there must be covered for a full interoperability test of the connector.

*Note*: The Anypoint Studio plugin covers only the following cases: 
 * Connectivity testing
 * Datamapper compliance
 * Xml generation

== Glossary

* Runner platform: Host where the test run will take place.
* Target platform: Describes the platform (in terms of Studio plugins) on which tests are going to we run. 
* CUT: Connector under test
.. *-test-data.xml +
.. *-test-data-override.xml

== Installation 

=== Step 1: Check System Requirements
. http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html[JDK 7] 
. http://maven.apache.org/download.cgi[Apache Maven]
. http://www.mulesoft.org/download-mule-esb-community-edition[Anypoint Studio]

=== Step 2: Anypoint Devkit Plugin
Follow these steps on the Runner Platform's Anypoint Studio installation:

 . Click *Help* > *Install New Software*.
 . Click *Anypoint Addons Update Site* from the *Work with* drop-down. *Note*: If this item is not in the dropdown, click *Add* and specify the name, and for the URL, use: http://studio.mulesoft.org/r3/addons/beta
 . Click the checkbox for *Anypoint DevKit Plugin*, and click *Next, Next*, *Finish*. 
 . Restart Anypoint Studio when prompted.
 . Confirm you have Maven installed:
 .. Open the Anypoint Studio preferences (on a Mac, click *Anypoint Studio* > *Preferences*, on a Windows computer, click *Window* > *Preferences*). 
 .. Navigate to *Anypoint Studio* > *Maven Settings* and ensure that the Maven installation home directory points to the directory where you installed Maven. 
 .. Click *Test Maven Configuration* to ensure that Maven is correctly configured.

== Interop Test Run Tutorial
=== Step 1: Anypoint Connector Project in Workspace
If you have an existing connector project, import it into Anypoint Studio with this command: `mvn eclipse:eclipse` +
Import the project as *Anypoint Connector Project from External Location*

=== Step 2: Generating Test Data Files
If you are not familiar with testData files used for interop testing, refer to Appendix B. +
Right-click the name of your connector in the Package Explorer and click  +
*Anypoint Connector > Generate Tests*:

image::{imagesdir}/test-plugin-1.png[]

The *Tests Scaffolding Generation* dialog lets you select the operations in scope and the different files type of tests, functional or interoperability, that the required test data files generate:

image::{imagesdir}/test-plugin-2.png[]

Interop Test Data Generation setup:

 . Click the *Select All* button. The generation considers all available message processors of the connector.
 . Under Studio Interop Tests, check *Generate Interop Test Data Files*
 . Leave the default test data filename *interop-testdata.xml* or define one of your own. The default behavior in case of finding matching filenames on the output folder is to update them. 
 . Credentials File expected input is the path to a .properties file, which is used to determine which Configuration Element fields are required for authentication. The effects of this can be seen on the <connectorName>-testData-override.xml file. For example .properties contains:
----
salesforce.username=salesforce.username.value +
salesforce.password=salesforce.password.value +
salesforce.securityToken=salesforce.securityToken.value +
salesforce.url=salesforce.url.value
----

This generates a config element on the <connectorName>-testData-override.xml file such as:

[source,xml]
----	
<config name="config"> 
  <attributes> 
    <attribute name="username" use="required" caption="Username"  
      group="Connection" type="string" javaType="java.lang.String"    
      prefix="salesforce">salesforce.username.value</attribute> 
    <attribute name="password" use="required" caption="Password"  
      group="Connection" type="password" javaType="java.lang.String"  
      prefix="salesforce">salesforce.password.value</attribute> 
    <attribute name="securityToken" use="required" caption="Security Token" 
      group="Connection" type="string" javaType="java.lang.String"  
      prefix="salesforce">salesforce.securityToken.value</attribute> 
    <attribute name="url" use="required" caption="Url" group="Connection"  
      type="string" javaType="java.lang.String"  
      default="https://login.salesforce.com/services/Soap/u/31.0" 
      prefix="salesforce">salesforce.url.value</attribute> 
  </attributes> 
</config>
----

The result of this command should be the following files (see Files section for details):  +
_- nameOfOutputFile.xml _ +
Basic data retrieved from the connector. Provides a complete view of every processor and all its attributes.

_- nameOfOutputFile-override.xml_ +
Presents a subset of the data found in the previous file, with only the required fields, but adds information about the connector and processor features and properties

For this tutorial, <testDataFilename>.xml and <testDataFilename>-override.xml files are the result of the Tests Scaffolding Generation process for Studio Interop Tests. Generated files are placed on src/test/resources/generated.

=== Step 3: Customizing Test Data Files
After the testData and testData-override files are created (details about this files in Appendix), the next step is to populate the content from your domain model. This implies the completion of valid inputs for the operations and configurations, and the validation of the retrieved data. 
	
==== Attention Points 
 * Properties detected must be checked and asserted: 
 ** The fact that the connector has connectivity support must be validated. If your connector does not support connectivity, but it was detected as a supported feature, you’ll have to double check your code.
 ** If the connector has OAuth support, then connectivity detection must be false.
 ** If the connector has OAuth support, then metadata detection should not be dynamic.
 ** For each processor, _query-support_ and _auto-paging_ properties should be coherent with the expected values.
 ** Required fields, both in the config and in the processors should be coherent with the expected values declared in the processor declaration. Those annotated with @Optional should be _optional_, everything else should be _required_.

 * Datamapper input/output fields: 
 ** Datamapper Input and Output attributes in each processor represent the values you expect to see at design time when you drop the connector before and after a datamapper element. This values should be empty only if you expect to see nothing in DataMapper.
 ** In a dynamic metadata case, the value of input/output attributes will be bound to the value with which the operation is feeded. 
For example, with dynamic metadata, if you have: 

[source,xml]
----	
<properties>
	<datamapper input="List&lt;SaveResult&gt;"output="List&lt;Map&gt;"/> 
</properties>
<attributes>
	<attribute name="type" use="required" caption="sObject Type"
	group="Information" type="type-chooser" javaType="java.lang.String">
	</attribute>
</attributes>
----
The output value is bounded to the value declared in the type chooser as follows:
		
*Case Account*

[source,xml]
----	
<properties>
	<datamapper input="List&lt;SaveResult&gt;"output="List&lt;Account&gt;"/> 
</properties>
<attributes>
	<attribute name="type" use="required" caption="sObject Type" group="Information" 
	type="type-chooser" javaType="java.lang.String"> Account (Account)
	</attribute> 
</attributes>
----

*Case Contact*

[source,xml]
----	
<properties>
	<datamapper input="List&lt;SaveResult&gt;"output="List&lt;Contact&gt;"/>
</properties>
<attributes>
	<attribute name="type" use="required" caption="sObject Type" 	
	group="Information" type="type-chooser" javaType="java.lang.String"> Contact (Contact)
	</attribute> 
</attributes>
----

 ** If metadata model is static, then the expected value should be the initial one, with _“List<Map>”_ as the output value.

=== Step 4: Run Interop Tests
	
In Studio, right-click the project and click *Anypoint Connector *>* Run Interop Tests*:

image::{imagesdir}/test-plugin-3.png[]

The Interop Remote Runner Properties menu shows the existing testData files that were created previously, and a set of options: 

 * Tests to run:  Select which kind of test to run on your connector.
 ** Connectivity
 ** Data Mapper
 ** Xml Generation

 * Verbose Mode
 ** Enables debugging logs on the test runs
	
image::{imagesdir}/test-plugin-4.png[]
	
The results appear in target/surefire-reports, and provide jUnit results using the XML result file.

== Appendix

. https://github.com/mulesoft/connector-certification-docs/blob/docs/current/attachments/studio%20test%20plugin/appendixA.adoc[Appendix A: Usage without Studio]
. https://github.com/mulesoft/connector-certification-docs/blob/docs/current/attachments/studio%20test%20plugin/appendixB.adoc[Appendix B: Plugin Result Files]
. https://github.com/mulesoft/connector-certification-docs/blob/docs/current/attachments/studio%20test%20plugin/projectDetails.adoc[Project Details]

