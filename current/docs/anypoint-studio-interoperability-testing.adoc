== Purpose

Based on these guidelines, analyze the connector you're testing and provide a test suite build from these generic test cases (only a document with general and operation­specific test cases titles) with all tests in +Passed+ status.

Specific test cases from the Interop Test guideline are automated and their execution in Anypoint Studio using the DevKit Plugin is described next.

== Running Automated Interop Tests using DevKit Plugin

:leveloffset: 1

include::devkit-plugin-run-interop-tests-action.adoc[]

:leveloffset: 0

== OAuth Authentication
=== OAuth - Global Configuration Element

==== Preconditions
* Create and open a Mule Project using your connector.
* Make connector code available to review configurations.

==== Steps
* *Step 1:*
.. In Anypoint Studio, search for and place an *HTTP* connector on the canvas
.. Drop the desired connector inside the flow.
.. Select the connector and click the Connector Configuration green plus symbol Edit button.

----
Expected Result:

 * Connector class attributes marked as @Configurable display.
 * The consumerKey and consumerSecret are annotated with @OAuthConsumerKey and @OAuthConsumerSecret.
----

* *Step 2:* Enter valid access credentials and save.
----
Expected Result:
Create and save global configuration element.
----


=== OAuth - Project Arrangement and Configuration Verification

Build this test case to serve as the basis for the next set of test cases.

==== Preconditions

* Global element was already created for the connector and valid OAuth credentials (consumerKey, consumerSecret, and callback URL) have been entered.
* Make connector code available to review configurations.

==== Steps

* *Step 1:* Arrange a flow in the following way:
.. Place an *HTTP* connector on the canvas.
.. Place two consecutive connectors in the flow.
.. Place a *Logger* after the last connector.
.. Add a *Set Payload* element after the logger.

----
Expected Result:

Flow arrangement looks similar to this:
----

image::{imagesdir}/qa-guidelines/qa-guidelines-1.png[]


* *Step 2:* In the *HTTP* connector configuration, set the path value to *authorize*.
* *Step 3:*
.. Select the first connector.
.. Look for the Authorize operation.

----
Expected Result:
Authorize operation is found.
----

* *Step 4:*
.. Select the Authorize operation.
.. Check the General section.

----
Input fields are found for:
* State (only for OAuth2)
* Access Token URL
* Authorization URL
----


* *Step 5:* Look for the authorizationParameters inside the OAuth annotation.
----
Expected Result:
Each of the annotations on authorizationParameters are reflected in the Additional Authorization Parameters section. If none, the section is not displayed at all.
----

* *Step 6:* In case of OAuth2m set a state value of +testState+. Click *Save*

* *Step 7:* On the second connector, select any operation (besides Authorize and Unauthorize) and configure it. Click *Save*.

* *Step 8:* Set +Operation payload is #[message.payload]+ as the *Logger* message value. Then click *Save*.

* *Step 9:* Arrange a flow in the following way:
.. Place an *HTTP* connector on the canvas.
.. Drop a connector in the flow.
.. Drop a *Logger* after the last connector.
.. Finally, add a *Set Payload* element after the logger.

----
Expected Result:
Flow arrangement looks similar to this:
----

image::{imagesdir}/qa-guidelines/qa-guidelines-2.png[]

* *Step 10:* On the *HTTP* connector, set a path value of +anoperation+.

* *Step 11:* On the connector, select any operation (besides Authorize and Unauthorize) and configure it. Click *Save*.

* *Step 12:* Set +Operation payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 13:* Arrange a flow in the following way:
.. Place an *HTTP* connector on the canvas.
.. Drop a connector in the flow.
.. Drop a *Logger* after the last connector.
.. Finally, add a *Set Payload* element after the
logger.

----
Expected Result:

Flow arrangement looks similar to this:
image::{imagesdir}/qa-guidelines/qa-guidelines-3.png[]
----
￼
* *Step 14:* On the connector, look for the Unauthorize operation.
----
Expected Result:
Unauthorize operation is found.
----

* *Step 15:* Select the Unauthorize operation. Click *Save*.

* *Step 16:* Set +Done.+ on all *Set Payload* elements Values. Click *Save*.

Expected Result:

Example of the project flows:

[source,xml]
----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>

<flow name="authorize" doc:name="authorize">

<http:listener config-ref="HTTP_Listener_Configuration" path="authorize" doc:name="HTTP"/>

    <sfdc:authorize config-ref="Salesforce__OAuth_" display="POPUP"
    doc:name="Authorize" />

    <!-- <sfdc:authorize config-ref="Salesforce__OAuth_" display="POPUP"
    doc:name="Authorize"/> -->

    <sfdc:get-user-info config-ref="Salesforce__OAuth_" doc:name="Get user info" >
    </sfdc:get-user-info>

    <logger message="#[message.payload]" level="INFO" doc:name="Logger"/>
    <set-payload value="Done." doc:name="Set Payload"/>
</flow>

<flow name="aConnectorOperation" doc:name="aConnectorOperation">

<http:listener config-ref="HTTP_Listener_Configuration" path="anoperation" doc:name="HTTP"/>
    <sfdc:describe-global config-ref="Salesforce__OAuth_" doc:name="Describe global"/>
    <logger message="#[message.payload]" level="INFO" doc:name="Logger"/>
    <set-payload value="Done." doc:name="Set Payload"/>
</flow>


<flow name="unauthorize" doc:name="unauthorize">

<http:listener config-ref="HTTP_Listener_Configuration" path="unauthorize" doc:name="HTTP"/>
    <sfdc:unauthorize config-ref="Salesforce__OAuth_" doc:name="Unauthorize"/>
    <set-payload value="Done." doc:name="Set Payload"/>
 </flow>
----

=== OAuth - Authorized Connector Requests
==== Preconditions

* Global element was already created for the connector and valid OAuth credentials (consumerKey, consumerSecret and callback URL) have been entered.
* OAuth ­ Project arrangement and configuration verifications test case was completed successfully
* Connector code is available to review configurations.

==== Steps

* *Step 1:*
.. Run the app and hit the authorize endpoint.
.. Complete the OAuth dance.
----
Expected Result:
* Redirects to the authorization URL of the service provider, which occurs according to authorizationParameters.
* Access is granted.
* Callback URL is shown in the browser address bar.
----

* *Step 2:*
Check the console.
----
Expected Result:
Operation payload is logged.

This implies that the logic contained in the @OAuthPostAuthorization to establish connections to make requests was executed.
Check the State parameter
----
* *Step 3:*
.. Hit the anoperation endpoint.
.. Check the console.
----
Expected Result:
Operation payload is logged.

This implies that Mule included the access token (contained within the parameters annotated with @OAuthAccessToken) in the request to the service provider.
----

* *Step 4:*
.. Hit the unauthorize endpoint.
.. Check the console.

----
Expected Result:
OAuth session is killed.
----

=== OAuth - Unauthorize Connector Requests
==== Preconditions
* Global element was already created for the connector and valid OAuth credentials (consumerKey, consumerSecret and callback URL) have been entered.
* OAuth ­Project arrangement and configuration verifications test case was completed successfully
* Connector code is available to review configurations.

==== Steps
* *Step 1:* Run the app and hit the anoperation endpoint.
----
Expected Result:
The consumer operation throws a NotAuthorizedException.
----
* *Step 2:*
.. Hit the authorize endpoint.
.. Complete the OAuth dance.
.. Check the console.
----
Expected Result:
Operation payload is logged.
----

* *Step 3:*
.. Hit the unauthorize endpoint.
.. Check the console.
----
Expected Result:
OAuth session is killed.
----

* *Step 4:*
.. Hit the anoperation endpoint.
.. Check the console.
----
Expected Result:
The consumer operation throws a NotAuthorizedException.
----

* *Step 5:*
.. Hit the unauthorize endpoint.
.. Check the console.
----
Expected Result:
Flow is run. No exception is thrown.
----

=== OAuth - Access Token Expiration
==== Preconditions
* Global element was already created for the connector and valid OAuth credentials (consumerKey, consumerSecret and callback URL) have been entered.
* OAuth ­ Project arrangement and configuration verifications test case completed successfully.
* Connector code is available to review configurations.
* Regular expression for the expirationRegex parameter was specified on the OAuth2 annotation.

==== Steps
* *Step 1:*
.. Hit the authorize endpoint.
.. Complete the OAuth dance.
.. Check the console.
----
Expected Result:
Operation payload is logged.
----

* *Step 2:* Meet access token expiration criteria.

* *Step 3:* Hit the anoperation endpoint.
----
Expected Result:
Expiration is detected and OAuth dance is triggered.
----

* *Step 4:*
.. Complete the OAuth dance.
.. Check the console.

----
Expected Result:
Operation payload is logged.
----

=== OAuth - Operation Not Supported Due to Scope Parameter
==== Preconditions
* Global element was already created for the connector and valid OAuth credentials (consumerKey, consumerSecret and callback URL) have been entered.
* OAuth ­ Project arrangement and configuration verifications test case was completed successfully.
* Connector code is available to review configurations.
* Connector declares a @OAuthScope attribute.

==== Steps

* *Step 1:* Open the Global Configuration element of the Connector and set a valid Scope value that's not supported by the operation on the authorize flow.
----
Expected Result:
Scope value is overridden.
----

* *Step 2:*
.. Run the app and hit the authorize endpoint.
.. Complete the OAuth dance.
----
Expected Result:
* Redirects to the authorization URL of the service provider that occurs according to authorizationParameters
* Access is granted.
* Callback URL is shown in the browser
address bar.
----

* *Step 3:* Check the console.
----
Expected Result:
No permission to access resource error displays.
----

* *Step 4:*
.. Hit the unauthorize endpoint.
.. Check the console.
----
Expected Result:
OAuth session is killed.
----

== Anypoint Studio Interoperability Testing
== Anypoint Studio Installation

=== Anypoint Studio - Installation Wizard

==== Preconditions

* Anypoint Studio is installed on the local machine.
* Connector already available on the update site.

==== Steps

* *Step 1:* In Anypoint Studio click *Help > Install New Software*

* *Step 2:* From the *Work with* dropdown select *Anypoint Studio Connectors Update Site*
----
Expected Result:
Connector categories are listed.
----
* *Step 3:* Search for the <connectorName>.
----
Expected Result:
Connector matching criteria displays. Format should be:
<connectorCategory>
Mule <connectorName> Connector (Mule 3.5+)
Mule <connectorName> Connector Anypoint Studio Extension
Refer to screenshot.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-4.png[]

* *Step 4:* Click the connector.
----
Expected Result:
Details text area updates to display connector information.
----

* *Step 5:*: Check the connector version and click *Next*.
----
Expected Result:
Install Details step displays.
----

* *Step 6:* Click Next.
----
Expected Result:
Review Licenses step displays. The license text content loads and applies to the connector category.
----

* *Step 7:* Click Finish.
----
Expected Result:
Installation starts. No unsigned content warning is displayed during installation.
Anypoint Studio is restarted after installation.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-5.png[]


* *Step 8:* After Anypoint Studio finishes loading, search for <connectorName>.
----
Expected Result:
Connector displays under the Connectors category.
----

=== Anypoint Studio - Icons
==== Preconditions
* Anypoint Studio is installed on the local machine.
* Connector already installed.

==== Steps
* *Step 1:* Search for the <connectorName>.
----
Expected Result:
Icon displays on the Palette, which relates to the service the connector connects to.
----

* *Step 2:* Drop a Flow element on the canvas. Afterwards select the connector from the Palette and place it within the Flow.
----
Expected Result:
Icon displays and relates to the service the connector connects to.
----

* *Step 3:* If MessageSources are supported by the connector drag the connector from the Palette to the Canvas.
----
Expected Result:
Message Source icon for the connector displays.
----

== Multiple Extensions
=== Anypoint Studio - Multiple Extensions Installed - 3.5.x Server Runtime
==== Preconditions
* Anypoint Studio is installed on the local machine.
* 3.5.0 runtime project was created.
* 3.5.0 and 3.4.x version of the connector are already installed.

* *Step 1:*
.. Search for the <connectorName>.
.. Drop a Flow element on the canvas.

* *Step 2:* Drag the connector from the Palette and place it within the Flow.
----
Expected Result:
Select a version ... dialog appears.
----

* *Step 3:* Click *Use newest*
----
Expected Result:
* Connector is added to the canvas.
* Connector related library is added to project.
Version corresponds to the 3.5.0 connector.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-6.png[]

* *Step 4:* Secondary click the connector and select remove libraries for project.
----
Expected Result:
Library is removed from project.
----

* *Step 5:*
.. Remove the connector from the canvas.
.. Drag the connector from the Palette and place it within the Flow.
----
Expected Result:
Select a version ... dialog appears.
----

* *Step 6:* Click Choose manually.
----
Expected Result:
* Connector is added to the canvas.
* Connector related library is added to project.
Version corresponds to the 3.5.x connector.

image::{imagesdir}/qa-guidelines/qa-guidelines-7.png[]
----

* *Step 7:*￼ Secondary click the connector and select remove libraries for project.
----
Expected Result:
Library is removed from the project.
----

* *Step 8:*
.. Remove the connector from the canvas.
.. Drag the connector from the Palette and place it within the Flow.
----
Expected Result:
Select a version ... dialog appears.
----

* *Step 9:* Click Choose manually.
----
Expected Result:
* Select extension version screen displays.
* For the 3.5.0 version, check that the library version matches the one previously displayed.
* For the 3.4.x version, schema version displays.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-8.png[]


* *Step 9:* Randomly select one of options and click *OK*.
----
Expected Result:
Connector is added to the canvas. Check that the library version matches the one previously displayed for that version.
----

=== Anypoint Studio - Multiple Extensions Installed - 3.5.x Server Runtime - Message Sources
=== Anypoint Studio - Multiple Extensions Installed - 3.4.x Server Runtime
=== Anypoint Studio - Multiple Extensions Installed - 3.4.x Connector Running on 3.5.x Server Runtime

== Global Element Properties
=== Global Element Properties - Basic Authentication Connectors - Hidden Password Text
==== Steps

* *Step 1:* Open Global Element.
* *Step 2:* Populate password field.
----
Expected Result:
Password field’s text is hidden by default.
----

== Connectivity
This is part of connection management.

=== OAuth Connectors
==== Connectivity - OAuth Connectors - Test Connectivity Button Not Available
[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.|Test connectivity ... button is not available.
|===


=== Non-OAuth connectors
For the following tests, the connector has connectivity.

==== Connectivity - Non-OAuth Connectors - Positive - String Values

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.|Test connectivity ... button is available.
|2|Populate all Connection mandatory fields with valid credentials and click the *Test connectivity* button.|Test connection successful is returned.
|===

==== Connectivity - Non-OAuth Connectors - Positive - Placeholders as Credentials
*Preconditions*

* mule.properties file contains properties values that are under src/main/resources.
* Property placeholder element referencing mule.properties was created.

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1| Open Global Configuration element.| Test connectivity ... button is available.
|2| Populate all Connection mandatory fields with property placeholders and click the *Test connectivity* button.| Test connection successful is returned.
|===

==== Connectivity - Non-OAuth Connectors - Negative - Invalid Credentials

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.| Test connectivity ... button is available.
|2|One at the time, enter an invalid value on each of the Connection mandatory fields and click the *Test connectivity* button.| Test connection failed is returned. org.mule.api.ConnectionException is raised stating a useful error message to the user.
|===

==== Connectivity - Non-OAuth Connectors - Negative - Empty Fields

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.| Test connectivity ... button is available.
|2 | One at the time, leave empty the value of one of the Connection mandatory fields and click the *Test connectivity* button.| Test connection failed is returned. org.mule.api.ConnectionException is raised stating a useful error message to the user.
|===

== Metadata
=== Dynamic Metadata
Supported by Non­OAuth connectors.

==== Dynamic Metadata - Enable DataSense - Positive - String Values
[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.| Enable DataSense checkbox displays and is checked by default.
|2|Populate all Connection mandatory fields with valid credentials and click *OK*.| Getting DataSense metadata types finishes successfully and configuration is saved.
|===

==== Dynamic Metadata - Enable DataSense - Positive - Placeholders as Credentials
*Preconditions*

* mule.properties file contains properties values that are under src/main/resources.
* Property placeholder element referencing mule.properties was created.

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.| Enable DataSense checkbox displays and is checked by default
|2|Populate all Connection mandatory fields with property placeholders and click the *Test connectivity* button.| Getting DataSense metadata types finishes successfully and configuration is saved.
|===

Run the following set of test cases at operation level. For each of the connector operations, evaluate which set of the following test cases applies. Also, take into account that more than one attribute of an operation supports this configuration.
[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.| Enable DataSense checkbox displays and is checked by default.
|2|Populate all Connection mandatory fields with property placeholders and click *OK*.| Getting DataSense metadata types doesn't display and the configuration is saved.
|===

==== Dynamic Metadata - Enable DataSense - Positive - Disable DataSense

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open *Global Configuration element*.|*Enable DataSense* checkbox displays and is checked by default.
|2|Populate all *Connection* mandatory fields with valid credentials.|
|3|Uncheck Enable DataSense checkbox.|
|4|Click *OK*.|Getting DataSense metadata types doesn't display and the configuration is saved.

|===

==== Dynamic Metadata - Enable DataSense - Negative - Invalid Credentials
[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.|Enable DataSense checkbox displays and is checked by default.
|2|One at the time, leave empty the value of one of the Connection mandatory fields and click *OK*.|Getting DataSense metadata types fails. org.mule.api.ConnectionException is raised stating a useful error message to the user.
|===
The http://mulesoft.github.io/marketo-connector/mule/marketo-config.html#sync-lead[sync­lead operation of the Marketo connector] is used to demonstrate.

==== Dynamic Metadata - XML Generation - Custom Entities and Fields - Object Attributes Defined Through the Object Builder
*Preconditions*

* On the connector, Global Configuration DataSense is enabled and DataSense metadata types were fetched successfully.
* In the Anypoint Studio canvas, place a connector building block inside a flow.
* Connector was selected.
* Operation under test consumes an entity for which a custom entity or custom fields on an entity were defined on the service.
* No DataSense metadata was fetched for the operation under test.

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|On the General tab select the corresponding Config reference.|
|2|Select the operation.|
|3|Select an Object type (if not already defined by default by the operation) that's custom or has a custom field.|List of Object types display based on the retrieved metadata from the service.
|4|For the child elements, select the Create Objects manually option and click the ... (browse) button.| Getting DataSense metadata ... popup displays. Object builder displays Objects fields. Defined custom field displays among them.
|5|Populate the desired object fields and click *OK*.|
|6|Save and change to the *Configuration XML* view.|
Operation configuration is reflected on the XML. Example XML:
----
<marketo:sync-lead config-ref="Marketo" doc:name="Marketo">
<marketo:lead-record >
<marketo:lead-record key="City">#[flowVars['City']]</marketo:lead-r ecord>
<marketo:lead-record key="AnnualRevenue">#[flowVars['AnnualRevenue' ]]</marketo:lead-record>
<marketo:lead-record key="Department">#[flowVars['Department']]</ma rketo:lead-record>
<marketo:lead-record key="Company">#[flowVars['Company']]</marketo: lead-record>
</marketo:lead-record> </marketo:sync-lead>
----
|===

=== Static Metadata
In case of static metadata, Anypoint Studio retrieves the POJO, List<POJO>, or Map<String,POJO>attribute from the connector code.

OAuth connectors with static metadata support:

* Salesforce (Non­OAuth)

==== Static Metadata - Non DataSense-Enabled
[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|Open Global Configuration element.| Enable DataSense checkbox is not displayed.
|===

Run the following set of test cases at operation level. For each of the connector operations, evaluate which set of the following test cases applies. Also, take into account that more than one attribute of an operation supports this configuration.

==== Static Metadata - XML Generation - Object Attributes Defined Through the Object Builder
*Preconditions*

* On the connector Global Configuration, DataSense metadata types were fetched successfully.
* In the Anypoint Studio canvas, a connector building block was placed inside a flow.
* Connector is selected.
* No DataSense metadata was fetched for the operation under test.

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|On the General tab, select the corresponding Config reference.|
|2|Select the operation.|
|3|Randomly select an Object type (if not already defined by default by the operation).| Object types are based on the metadata retrieved from the connector.
|4|For the child elements, select the Create Objects manually option and click the ... (browse) button.|Getting DataSense metadata ... popup displays. Object builder displays Objects fields.
|5|Populate the desired object fields and click *OK*.|
|6|Save and change to the Configuration XML view.| Operation configuration is reflected on the XML.
|===

=== Metadata / XML Generation
==== Metadata - XML Generation - Non-OAuth - Positive - Object Attributes Not Defined
*Preconditions*

* For Non­OAuth connectors that support dynamic metadata, on the connector Global Configuration DataSense was enabled and DataSense metadata types were fetched successfully.
* In the Anypoint Studio canvas, a connector building block was placed inside of a flow.
* Connector was selected.
* No DataSense metadata was fetched for the operation under test yet.

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|On the General tab select the corresponding Config reference.|
|2|Select the operation.|
|3|Randomly select an Object type (if not already defined by default by the operation).|
|4|As child elements, select the None option.|
|5|Save|
|6|Save and change to the Configuration XML view.| Getting DataSense metadata ... popup displays.
|===

==== Metadata - XML Generation - Non-OAuth - Positive - Object Attributes Passed by Reference
*Preconditions*

* For Non­OAuth connectors that support dynamic metadata, on the connector Global Configuration, DataSense was enabled and DataSense metadata types were fetched successfully.
* In the Anypoint Studio canvas, a connector building block was placed inside a flow.
* Connector was selected.
* No DataSense metadata was fetched for the operation under test.

[cols=".^10%,.^45%,.^45%"]
|===
|Step|Description|Expected Result

|1|On the General tab select the corresponding Config reference.|
|2|Select the operation.|
|3|Randomly select an Object type (if not already defined by default by the operation).|
|4|For the child elements, select the From Message option and enter #[flowVars['objectRef']]as the value.|
|5|Save.| Getting DataSense metadata ... popup displays.
|6|Change to the Configuration XML view.| Operation configuration is reflected on the XML. Example XML above

|===

[source,xml]
----
<code>
    <marketo:sync-lead config-ref="Marketo" doc:name="Marketo">
    <marketo:lead-record ref="#[flowVars['leadRecordRef']]"/>
    </marketo:sync-lead>
</code>
----


==== No Metadata
This is defined by the argument types and return types of the API. If all of them are either primitive types or of type InputStream, the connector falls in the No metadata category.



== XML Generation
=== XML Generation - POJO by ‘Reference or expression’ or ‘Define attributes’
==== Steps

* *Step 1:* On the General tab select the corresponding Config reference.
* *Step 2:* Select the operation.
* *Step 3:* For the POJO no option is available by default.

* *Step 4:* Select the Reference or expression option and enter #[flowVars[‘ref’]]as the value.
Example:
image::{imagesdir}/qa-guidelines/qa-guidelines-9.png[]

* *Step 5:*
Save and change to the Configuration XML view.

[source,xml]
----
Expected Result: XML for the operation was generated using the ref attribute.
Example XML:

<sfdc:batch-info config-ref="Salesforce" doc:name="Salesforce" >
<sfdc:batch-info ref="#[flowVars['batchInfoRef']]"/> </sfdc:batch-info>
----

* *Step 6:* Return to the Message Flow view, click the connector.
----
Expected Result:

Same operation is selected, Reference or expression is selected for the POJO and the value was stored.
----

* *Step 7:*
￼For the same POJO select the Define attributes option and enter #[flowVars[‘pojoAttribute’]] for the Id and Job Id values.
Example:
image::{imagesdir}/qa-guidelines/qa-guidelines-10.png[]

* *Step 8:* Save and change to the Configuration XML view.

[source,xml]
----
Expected Result:
XML for the operation was generated defining each of the POJO attributes.
Example XML:
<sfdc:batch-info config-ref="Salesforce" doc:name="Salesforce" >
<sfdc:batch-info id="#[flowVars['id']]" jobId="#[flowVars['jobId']]" state="Completed"/>
</sfdc:batch-info>
----
* *Step 9:*  Return to the Message Flow view, click the connector.
----
Expected Result:

Same operation is selected, Define attributes is selected for the POJO and the attributes values were stored.
----

=== XML Generation - Attribute Names Consistency
Operations attributes names should be the same as the ones from the API, but in case, this rule introduces inconsistencies among operations; then the parameter name should be corrected in the connector. As an example:

|===
|Library/API method| Expected result
|org.eclipse.egit.github.core. +
service.GistService.del eteGist(String gistId)| @Processor +
public void deleteGist(String gistId) throws IOException { +
... }
|org.eclipse.egit.github.core. +
service.GistService.get Gist(String id)| @Processor +
public Gist getGist(String gistId) throws IOException { +
... }
|===

=== XML Generation - Attribute Order
Order of operation attributes should be the same as in the API. Attributes generated in the wrong order cause errors in the XML at runtime.

=== XML generation - Required Attribute Value not Defined
==== Preconditions

* Applies to operations directly exposing fields (with no default value) on the Mule Properties View.
* In the Anypoint Studio canvas a connector building block was placed inside of a flow.
* Connector is selected.

==== Steps
* *Step 1:* On the General tab select the corresponding Config reference.

* *Step 2:* Select the operation.
----
Expected Result:
Operation required attributes values display as missing.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-11.png[]

* *Step 3:* Look for the operation in the API docs.
----
Expected Result:
Required attributes match with the ones marked as such in the Mule Properties View.
----

* *Step 4:* Back in Anypoint Studio, change to the Problems tab.

----
Expected Result:
'Required attribute not defined' error is logged.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-12.png[]

=== Message Sources
Methods annotated with @Source(). They are common for connectors to services with streaming APIs.

==== Preconditions

* Mule project was created and is open.
* Global Configuration element is already created with valid credentials to the service.
* Connector code is available to review configurations

==== Steps

* *Step 1:* Pull the desired connector to the canvas.
----
Expected Result:
Connector is created as endpoint to a flow.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-13.png[]

* *Step 2:*
.. Place a *Logger* next to it.
.. Set +Message Source received `#[message.payload]+ as its Message.`

* *Step 3:*
.. Set the Global Configuration Element to the connector.
.. Check the available operations.
----
Expected Result:

Operations on the dropdown match to methods marked as @Source on the connector code.
----

* *Step 4:*  Select the Message Source under test and configure it appropriately.

[source,xml]
----
Expected Result:

Example of a Mule flow:
<flow name="SubscribeToTopic" doc:name="SubscribeToTopic">
  <sfdc:subscribe-topic config-ref="Salesforce" topic="/ContactsDemo" doc:name="Subscribe To newAccountMessages Topic"/>
  <logger level="INFO" message="New account notification received: #[message.payload]" doc:name="Notification"/>
</flow>
----

* *Step 5:*
.. Run the Mule app.
.. Check the Console.
----
Expected Result:

Initialization message is logged:
INFO 2014-01-1317:59:17,210[HttpClient-29] org.mule.modules.salesforce.SalesforceBayeuxClient: subscribing /topic/ContactsDemo for the first time
----

* *Step 6:*
.. Trigger the event the Message Source is expecting.
.. Check the Console.

----
Expected Result:

Message Source response was logged.
----

== DataMapper Compliance
DataMapper automatic metadata population is defined by the message processor attributes’ annotations as well as the message processor's return type.

In the case of POJO operation attributes, at least one of them must be marked as `@Optional`. `@Default("#[payload]")` causes data to be automatically picked up in DataMapper.

If custom fields can be defined for objects in the service domain, choose them for testing DataMapper compatibility.


=== DataMapper Compliance - Dynamics/Static Metadata - Perceptive Flow Design

==== Preconditions

* In the connector code @Connect contains metaData = MetaDataSwitch.OFF
* Flow contains a connector-datamapper-connector building block arrangement that is on the canvas.

==== Steps

* *Step 1:* Configure both connectors with the same operation.
----
Expected Result:
Metadata is fetched for both configurations.
----
* *Step 2:* Select the DataMapper building block.
* *Step 3:* Check the Input panel.
[source,java]
----
Expected Result:
 Mule automatically prescribes the output of the operation for any of the following return types:
* Map
* POJO
* List<Map>
* List<String>
* List<POJO>
* List<List<String>>

Check that values match the operation signature.
----

* *Step 4:* Check the Output panel.
[source,java]
----
Expected Result:
Mule automatically prescribes the input of the operation only for an attribute of the following type:
* Map
* POJO
* List<Map>
* List<String>
* List<POJO>
* List<List<String>>

Check that it's marked as `@Default("#[payload]")` (for connectors older than 3.5.0-M4). The correct annotations should be `@Optional @Default(“#[payload]”)`
----
* *Step 5:*  Check the operation attributes in the API docs.
----
Expected Result:
The attribute marked as `@Default("#[payload]")` (for connectors older than 3.5.0-M4). The correct annotations should be `@Optional @Default(“#[payload]”)` (aka PRIMARY argument) should be:
* An entity related to the service in case more than one applies.
* An entity that can't be created and is necessarily another operation return type (if applicable) .
----

=== DataMapper Compliance - Generate Mapping From the Return Type
==== Preconditions

* Flow contains a connector­datamapper building block arrangement that is on the canvas.

[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Configure the connector with an operation returning POJO / List<POJO>, Map<String,POJO>, or List<Map<String, Object>>.|Metadata is fetched for both configurations.
|2|Select the DataMapper building block.|
|3|Check the Input panel.|Values are pre­populated.
|4|In the Output panel select Type XML.|
|5|Click on the User Defined radio button.|
|6|Click Generate default.|
|7|Generate mapping using default XML schema|Relationship is established.
|===

=== DataMapper Compliance - Generate Mapping to Operation Attribute
==== Preconditions

* Flow contains a datamapper­connector building block arrangement that is on the canvas.

[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Configure the connector with an operation that has either a POJO / List<POJO>, Map<String,POJO>, or List<Map<String, Object>> as its main argument.|Metadata is fetched for both configurations.
|2|Select the DataMapper building block.|
|3|Check the Output panel.|Values were pre­populated.
|4|In the Input panel select Type XML.|
|5|Click on the User Defined radio button.|
|6|Click Generate default.|
|7|Generate mapping using default XML schema|Relationship is established.
|===

=== DataMapper Compliance - Override Metadata
==== Preconditions

* Flow contains a connector­datamapper­connector building block arrangement that is on the canvas.


[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Configure both connectors with the same operation.|Metadata is fetched for both configurations.
|2|Select the DataMapper building block.|
|3|Check the Input and Output panel.|Values were pre­populated.
||The following steps are to be repeated for both the Output Panel and Input panel.|
|4|Override the provided metadata by clicking Change Type.|
|5|Select the connector from the Connector dropdown.|
|6|Make sure By Operation is selected and select the operation under test from the Operation dropdown.|
|7|Click the Object dropdown.|Operation return type is available in the dropdown.
|===

=== DataMapper Compliance - Dynamic Metadata - Custom Entities/Fields
This test case applies to connectors to services that support custom entities or custom fields in their entities.

==== Preconditions

* On the Global Configuration, DataSense is enabled and DataSense metadata types were fetched.
* Flow contains a connector­datamapper­connector building block arrangement that is on the canvas.
* Operation either consumes or returns an entity for which a custom entity or custom fields on an entity were defined on the service.

==== Steps

* *Step 1:* Configure both connectors with the same operation. For type, select the custom entity under test or the entity for which custom fields were defined on the sandbox.
For example:
image::{imagesdir}/qa-guidelines/qa-guidelines-14.png[]

----
Expected Result:

Metadata is fetched for both configurations.
----

* *Step 2:* Select the DataMapper building block.
----
Expected Result:

Values were pre­populated and relate to the entity under test.
----

* *The following step is to be run for either the Output Panel/Input panel.*

* *Step 3:* Generate a mapping (use a default map on the counter panel if necessary).

----
Expected Result:

Relationship is established.
DataMapper displays the custom entity or the custom fields of the entity under test.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-15.png[]

=== DataMapper Compliance - No Metadata - Perceptive Flow Design
==== Preconditions

* In the connector code @Connect contains metaData = MetaDataSwitch.OFF
* Flow contains a connector­datamapper­connector building block arrangement that is on the canvas.


[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Configure both connectors with the same operation.|Metadata is fetched for both configurations.
|2|Select the DataMapper building block.|
|3|Check the Input panel.|No values display.
|4|Check the Output panel.|No values display.
|===

== DataSense Query Editor / DSQL
Connectors QA scope limits to check if feature reflects connector specific configuration values.
As example use the Dynamics connector (MessageProcessor expects XML thus everything is overridden).

=== DataSense Query Editor - OAuth Connector - Only NQL Query Option Available
==== Preconditions

* Flow contains a connector building block that is on the canvas and its Global Configuration element was selected as Config Reference.

* *Step 1:* Select corresponding operation for message processor with attribute marked @Query.

----
Expected Result:

* For attribute marked @Query only Native Query Language option in dropdown displays.
----

image::{imagesdir}/qa-guidelines/qa-guidelines-16.png[]

----
* Return type dropdown does not display.
----

=== DataSense Query Editor - Non-OAuth Connector - DSQL and NQL Query Options Available

==== Preconditions

* Flow contains a connector building block that is on the canvas and its Global Configuration element was selected as Config Reference.

* *Step 1:* Select corresponding operation for message processor with attribute marked @Query.

----
Expected Result:

* For attribute marked @Query *Native Query Language* and *DataSense Query Language* option in dropdown displays.
----

image::{imagesdir}/qa-guidelines/qa-guidelines-17.png[]

* *Step 2:* Click the Query Builder ...
----
Expected Result:

Query Builder opens.
----

=== DataSense Query Editor - Non-OAuth connector - Query by NQL
==== Preconditions

* Flow contains a connector building block that is on the canvas, and its config­element is already set.
* A DataMapper building block has been placed next to the connector building block.

[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Select corresponding operation for message processor with attribute marked @Query.|For attribute marked @Query Native Query Language and DataSense Query Language options are displayed in the Language dropdown.
|2|Select NQL as Language.|Check that Return type dropdown displays.
|3|Make a Return type selection and then save.|
|4|Click the DataMapper element.|DataMapper is prepopulated according to Return type option selection (List<Return type>).
|===

=== DataSense Query Editor - Non-OAuth Connector - @Query Default Values
==== Preconditions

* Flow contains a connector building block that is on the canvas and its Global Configuration element was selected as Config Reference.
* No parameters are passed to the @Query annotation.

[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Select corresponding operation for message processor with attribute marked @Query and click  *Query Builder*|Order By dropdown, Limit, and Offset fields are available.
|2|Build a query that applies two filters and makes use of the Order By, Limit, and Offset values.
Click *OK*.|Query Text is populated reflecting query values.
|===

=== DataSense Query Editor - Non-OAuth Connector - Query Builder Reflects @Query Configuration
==== Preconditions

* Flow contains a connector building block that is on the canvas and its Global Configuration element was selected as Config Reference.
* Parameters are passed to the @Query annotation.

[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Select corresponding operation for message processor with attribute marked @Query and click  *Query Builder*|Order By dropdown, Limit, and Offset fields are available only if not passed as false to the annotation. Example: +
`@Query(limit = false, offset = false, orderBy = false)`
|2|Build a query that applies two filters. Click OK.|Query Text is populated. OR or AND operator is displayed between filters depending on configuration. Example:
`@Query(disabledOperators = QueryOperator.OR)`
|===

=== DataSense Query Editor - Non-OAuth connector - Query builder reflects service metadata configuration

*@MetaDataKeyRetriever* and *@MetaDataRetriever* annotated methods sets service specific configuration for Query Builder.
By default a Field "query configuration" (isWhereCapable, isSelectCapable, isOrderByCapable) are all true unless overridden by the service metadata.
Example:

[source,java]
----
// sObject isFromCapable (available in Types)
// public DefaultMetaDataKey(java.lang.String id, java.lang.String displayName, boolean isFromCapable);
new DefaultMetaDataKey(sobject.getName(), sobject.getLabel(), sobject.isQueryable())
// sObject attribute available in Fields and appears on the Filter dropdown depending on the service.
dynamicObject.addSimpleField(field.getName(), dataType).isWhereCapable(field.isFilterable());
// sObject attribute available in Fields and appears on the Order By dropdown depending on the service.
dynamicObject.addSimpleField(field.getName(), dataType).isOrderByCapable(f.isSortable());
----
==== Preconditions

* Flow contains a connector building block that is on the canvas and its Global Configuration element was selected as Config Reference.

==== Steps

* *Step 1:* Select corresponding operation for message processor with attribute marked @Query and click *Query Builder*

----
Expected Result:

Query Builder opens.
----

* *Step 2:* From service documentation derive equivalence classes such:

* Types not from­capable.
* Fields not filterable.
* Fields not sortable.
* Fields not selectable.
* ...

Select a representative value for each class.

----
Expected Result:

Object Builder reflects values.
----

=== DSQL - Non-OAuth Connector - Query Translation
Method annotated as @QueryTranslator contains logic to translate DSQL queries into NQL in case clauses or operators do not match those predefined by DSQL. +
Visitor classes (can be recognized by the extends DefaultQueryVisitor extends DefaultOperatorVisitor) that handle the mapping from a DSQL query into the service Native Query Language. +
SELECT, WHERE, OPERATORS and ORDERBY values can be overridden.

==== Preconditions

* Flow contains a connector building block that is on the canvas and its Global Configuration element was selected as Config Reference.

[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Select corresponding operation for message processor with attribute marked @Query and click   *Query Builder*|Query Builder is displayed.
|2|Build queries using query builder that make use of clauses and operators whose values are been overridden by the connector.|Query Text is populated in DSQL format.
|3|Change from DSQL to NQL and check that the translation has been made correctly.|Clauses and operators and correctly translated.
|===

=== DSQL - Non-OAuth Connector - Query Equivalence
==== Preconditions

* Flow contains a connector building block that is on the canvas and its Global Configuration element was selected as Config Reference.

[cols="10,45,45"]
|===
|Steps|Description|Expected result

|1|Select corresponding operation for message processor with attribute marked @Query and click  *Query Builder*|Query Builder is displayed.
|2|Build a query using query builder that make use of clauses and operators whose values are been overridden by the connector.|Query Text is populated in DSQL format.
|3| Run the Mule application. Then Hit the endpoint to retrieve results.|Take note of the query results
|4|Stop the application.|
|5|Change from DSQL to NQL and check that the translation has been made correctly.
|Clauses and operators and correctly translated.
|6| Run the Mule application. Then Hit the endpoint to retrieve results.|Query results are the same than the ones on the DSQL query.
|===

== Auto-Paging
Connector supports Auto­Paging if a least one of its operations is annotated as @Paged and returns a PagingDelegate. The following test cases apply to Non­query, DSQL and NQL operations.

=== Auto-Paging - Fetch Size Parameter
==== Preconditions

* Flow contains a connector building block that is on the canvas and its Global Configuration element was selected as Config Reference.

==== Steps

* *Step 1:* Select an operation whose return type is PagingDelegate<SomeEntity>.

----
Expected Result:

Paging section containing a Fetch Size input field is displayed in the General tab of the connector view.
----

image::{imagesdir}/qa-guidelines/qa-guidelines-18.png[]

Fetch Size value is 100 by default.


* *Step 2:* Enter a Fetch Size value other than 100. Save and change to the Configuration XML view.

[source,xml]
----
Expected Result:

fetchSize attribute is on the operation XML.
<google-contacts:get-contacts config-ref="Google_Contacts" doc:name="Google Contacts" fetchSize="30"/>
----

=== Auto-Paging - Empty Collection
==== ￼Preconditions

* Global Configuration element was already crea

==== Steps
* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector place a *For Each* scope.
.. Inside the *For Each* place a *Logger* element.
.. After the *For Each* place a *Set Payload* element.

----
Expected Result:

Flow arrangement looks similar to this:
----
image::{imagesdir}/qa-guidelines/qa-guidelines-19.png[]


* *Step 2:*
.. On the connector, select an operation whose return type is PagingDelegate<SomeEntity>.
.. Set parameter values such as no records are returned by the operation.
.. Click Save.

----
Expected Result:

Metadata is fetched for the selected operation.
----

* *Step 3:* Set +For element #[flowVars['counter']] payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 4:* Set +Done.+ as the *Set Payload* element Value. Click *Save*.

Example of a complete flow result:

[source,xml]
----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>

<flow name="features-autopaging-certFlow1"
doc:name="features-autopaging-certFlow1">

<http:listener config-ref="HTTP_Listener_Configuration" path="contacts" doc:name="HTTP"/>

    <google-contacts:authorize config-ref="Google_Contacts"
  doc:name="Authorize"/>

    <google-contacts:get-contacts config-ref="Google_Contacts" doc:name="Get contacts" updatedMax="2000-09-29T18:46:19-0700" datetimeFormat="yyyy-MM-dd'T'HH:mm:ssZ"/>

     <foreach doc:name="For Each">
       <logger message="For element #[flowVars['counter']] payload is #[message.payload]" level="INFO" doc:name="Logger"/>
  </foreach>

   <set-payload value="Done." doc:name="SetPayload"/>
</flow>
----

* *Step 5:* Run the app and hit the flow endpoint. Check the console afterwards.
----
Expected Result:

org.mule.routing.Foreach$CollectionMapSplitter: Splitter returns no results. If this is not expected, check your split expression.
Logs to the console.
----

=== Auto-Paging - Abort Iteration
Verify that after processing current element, iteration is terminated.

====￼ Preconditions

* Global Configuration element has been created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place the *Logger* element.
.. Next to the *Logger* put a *For Each* scope.
.. Inside the *For Each*, place a *Logger*, a DataMapper, and another *Logger*.
.. Following the *For Each*, place a *Set Payload* element.

----
Expected Result:

Flow arrangement looks similar to this:
----
image::{imagesdir}/qa-guidelines/qa-guidelines-20.png[]


* *Step 2:*
.. On the connector select an operation whose return type is
PagingDelegate<SomeEntity>.
.. Open Query Builder and generate a simple
query such as: SELECT CreatedById,CreatedDate,Description, OwnerId FROM Account LIMIT 3.
.. Set a fetchSize value of 1 or lower than the amount the amount of records been returned.
.. Click *Save*.

----
Expected Result:

Metadata fetches for the selected operation.
----

* *Step 3:*  Set +### Total amount of elements retrieved is
#[message.payload.size()]+ as the first
*Logger* message value. Click *Save*.

* *Step 4:* Select the *For Each* and set rootMessage as its +Root Message Variable Name+. Click *Save*.

* *Step 5:* Set +Closing the iterator: #[flowVars['rootMessage'].getPayload ().close()]+ as the message value for the first *Logger* within the *For Each*. Click *Save*.

* *Step 6:*  On the DataMapper element, create a mapping to a Default `Map<k,v>` object.
----
Expected Result:

Mapping is created.
----

* *Step 7:* Set +For element #[flowVars['counter']] payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 8:* Set +Done.+ as the Set payload element Value. Click *Save*.

Example of a complete result flow:

[source,xml]
----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>

<flow name="features-autopaging-salesforceFlow1"
doc:name="features-autopaging-salesforceFlow1">

<http:listener config-ref="HTTP_Listener_Configuration" path="apforeach" doc:name="HTTP"/>

   <sfdc:query config-ref="Salesforce" query="dsql:SELECT CreatedById,CreatedDate,Description,OwnerId FROM Account LIMIT 3"
   doc:name="Query" fetchSize="2"/>

  <logger message="### Total amount of elements retrieved is #[payload.size()]"
  level="INFO" doc:name="Size"/>

  <foreach doc:name="For Each">
     <data-mapper:transform config-ref="account_to_map" doc:name="Account To Map"/>
     <logger message="For element #[flowVars['counter']] payload is
    #[message.payload]" doc:name="Records"/>
  </foreach>

  <set-payload value="Done." doc:name="Set Payload"/>
</flow>
----

* *Step 10:*  Run the app and hit the flow endpoint.
* *Step 11:*  Look for the messages logged by the Records Logger on the console.

----
Expected Result:

Only a message for the first record logs.
----

== Non-Query Operations
As example, use Google Contacts connectors.

=== Auto-Paging - Non-Query Operation - Auto-Paged Output Handling - DataMapper
PagingDelegate is typed thus it's expected to work together with DataMapper.

==== ￼Preconditions

* Global Configuration element was already created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place a DataMapper element.

----
Expected Result:
----
image::{imagesdir}/qa-guidelines/qa-guidelines-21.png[]

* *Step 2:* On the connector, select an operation whose return type is PagingDelegate<SomeEntity>. Click *Save*.

----
Expected Result:

Metadata fetches for the selected operation.w
----

* *Step 3:*
Click the DataMapper element.
----
Expected Result:

Mule automatically prescribes the output of the operation as List<SomeEntity>. The type is in the connector code, for example: `List<GoogleContactEntry>`
for an operation returns: `PagingDelegate<GoogleContactEntry>`
----

* *Step 4:* In the Output Panel select:
.. Type: Map<k,v>
.. Click User Defined
.. Click Generate default
.. Click Create mapping

----
Expected Result:

Mapping creates.
----

=== Auto-Paging - Non-Query Operation - Auto-Paged Output Handling - Foreach Combined with DataMapper

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place a *For Each* scope.
.. Inside the *For Each*, place a DataMapper element.

----
Expected Result:
----

image::{imagesdir}/qa-guidelines/qa-guidelines-22.png[]

* *Step 2:* On the connector, select an operation whose return type is PagingDelegate<SomeEntity>. Click *Save*.
----
Expected Result:

Metadata fetches for the selected operation.w
----

* *Step 3:*
Click the DataMapper element.
----
Expected Result:

Mule automatically prescribes the output of the operation as `SomeEntity`.
The type is in the connector code, for example: `GoogleContactEntry` for an operation returns: `PagingDelegate<GoogleContactEntry>`
----

* *Step 4:* In the Output Panel select:
.. Type: Map<k,v>
.. Click User Defined
.. Click Generate default
.. Click Create mapping

----
Expected Result:

Mapping creates.
----

=== Auto-Paging - Non-Query Operation - Pagination is Applied

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows::
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector place a *Logger* element.
.. Next to the *Logger* put a For Each element.
.. Inside the *For Each* place a DataMapper and then a *Logger* next to it.
.. After the *For Each* place a *Set Payload* element.

----
Expected Result

Flow arrangement looks similar to this:
----
image::{imagesdir}/qa-guidelines/qa-guidelines-23.png[]


* *Step 2:*
.. On the connector, select an operation whose return type is PagingDelegate<SomeEntity>.
.. Set a fetchSize value of 1 or lower than the amount of records that's going to be retrieved.
.. Click *Save*.

----
Expected Result:

Metadata fetches for the selected operation.
----

* *Step 3:* Set +### Total amount of elements retrieved is
#[message.payload.size()]+ as the
*Logger* message value. Click *Save*.

* *Step 4:* On the DataMapper element, create a mapping to a Default Map<k,v> object.
Mapping creates.

* *Step 5:* Set +For element #[flowVars['counter']] payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 6:* Set +Done.+ as the *Set Payload* element Value. Click *Save*.

Example of a complete flow:

[source,xml]
----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>

<flow name="features-autopaging-datamapper-complianceFlow3"
doc:name="features-autopaging-datamapper-complianceFlow3">

<http:listener config-ref="HTTP_Listener_Configuration" path="foreachdm" doc:name="HTTP"/>

    <google-contacts:authorize config-ref="Google_Contacts"
    doc:name="Authorize"/>

    <google-contacts:get-groups config-ref="Google_Contacts"
    doc:name="Get groups"/>

    <logger message="### Total amount of elements retrieved is
  #[message.payload.size()]" level="INFO" doc:name="Size"/>

    <foreach doc:name="For Each">
      <data-mapper:transform doc:name="DataMapper"/>
      <logger message="For element #[flowVars['counter']] payload is
    #[message.payload]" doc:name="Records"/>
  </foreach>

    <set-payload doc:name="Set Payload" value="Done."/>
</flow>
----

* *Step 7:* Run the app and hit the flow endpoint.

* *Step 8:* Look for the messages logged by the Records Logger on the console.
----
Expected Result:

For each record a +For element ... + message was logged displaying its payload.
----

* *Step 9:* Look for the message of the Size Logger on the console.
----
Expected Result:

Amount of elements retrieved equals number of records returned.

Note: You can override the getTotalResults() method in the connector in case of service constraints.For this case, a value of ­1 is returns if the size can't be provided.
----

=== Auto-Paging - Non-Query Operation - Pagination is Not Applied

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows::
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place a *Logger* element.
.. Next to the *Logger*, place a *For Each* scope.
.. Inside the *For Each*, place a DataMapper and then a *Logger* next to it.
.. After the *For Each*, place a *Set Payload* element.
----
Expected Result:

Flow arrangement looks similar to this:
----

image::{imagesdir}/qa-guidelines/qa-guidelines-24.png[]

* *Step 2:*
.. On the connector, select an operation whose return type is PagingDelegate<SomeEntity>.
.. Set a fetchSize higher than amount of existing records.
.. Click *Save*.
----
Expected Result:

Metadata fetches for the selected operation.
----
* *Step 3:*  Set +### Total amount of elements retrieved is
#[message.payload.size()]+ as the
*Logger* message value. Click *Save*.

* *Step 4:* On the DataMapper element, create a mapping to a Default Map<k,v> object.
----
Expected Result:

Mapping is created.
----

* *Step 5:* Set +For element #[flowVars['counter']] payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 6:*  Set +Done.+ as the *Set Payload* element Value. Click *Save*.

Example of a complete flow:

[source,xml]
----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>

<flow name="features-autopaging-datamapper-complianceFlow3"
doc:name="features-autopaging-datamapper-complianceFlow3">

<http:listener config-ref="HTTP_Listener_Configuration" path="foreachdm" doc:name="HTTP"/>

    <google-contacts:authorize
  config-ref="Google_Contacts"
  doc:name="Authorize"/>

    <google-contacts:get-groups
  config-ref="Google_Contacts" doc:name="Get groups"/>

    <logger message="### Total amount of elements retrieved is
  #[message.payload.size()]" level="INFO"
  doc:name="Size"/>

  <foreach doc:name="For Each">
        <data-mapper:transform
      doc:name="DataMapper"/>
        <logger message="For element #[flowVars['counter']]  payload is
      #[message.payload]" doc:name="Records"/>
  </foreach>
    <set-payload doc:name="Set Payload" value="Done."/>
</flow>
----

* *Step 7:* Look for the messages logged by the Records Logger on the console.
----
Expected Result:

For each record a +For element ... + message was logged displaying its payload.
----

* *Step 8:*  Look for the message of the Size Logger on the console.
----
Amount of elements retrieved equals number of records returned.

Note: You can override the getTotalResults() method in the connector in case of service constraints.For this case, a value of ­1 is returns if size can't be provided.
----

== Auto-Paging DSQL Interoperability
An example that uses the Salesforce/NetSuite connectors.

=== DataSense Query Language

=== Auto-Paging - DSQL - Auto-Paged Output Handling - DataMapper

==== Preconditions

* Global Configuration Element was already created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place a DataMapper element.

----
Expected Result:
----

image::{imagesdir}/qa-guidelines/qa-guidelines-25.png[]

* *Step 2:*
.. On the connector select an operation whose return type is PagingDelegate<SomeEntity> and has one of its parameters annotated with @Query.
.. Select DataSense Query Language as Language.
.. Using Object Builder create a simple query involving a couple of fields, for example: SELECT AccountSource,BillingCity,BillingLon gitude,CreatedDate FROM Account.
.. Click Save.

----
Expected Result:

Metadata is fetched for the selected operation.
----

* *Step 3:* Click on the DataMapper element.
----
Expected Result:

Mule automatically prescribes the output of the operation as List<SomeEntity>. The type is in the connector code, for example: PagingDelegate<Map<String, Object>>
for an operation returns: PagingDelegate<Map<String, Object>>
----

* *Step 4:* In the Output Pane select:
.. Type: Map<k,v>
.. Click User Defined
.. Click Generate default
.. Click Create mapping

----
Expected Result:

Mapping involving only the fields been queried is created.
----

image::{imagesdir}/qa-guidelines/qa-guidelines-26.png[]

=== Auto-Paging - DSQL - Auto-Paged Output Handling - Foreach Combined with DataMapper

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place a *For Each* scope.
.. Inside the *For Each* place a DataMapper element.

----
Expected Result:
----
image::{imagesdir}/qa-guidelines/qa-guidelines-27.png[]


* *Step 2:*
.. On the connector select an operation whose return type is
PagingDelegate<SomeEntity> and has one of its parameters annotated with @Query.
.. Select DataSense Query Language as Language.
.. Using Object Builder create a simple query involving a couple of fields, for example: SELECT AccountSource,BillingCity,BillingLon gitude,CreatedDate FROM Account
.. Click Save.
----
Expected Result:

Metadata fetches for the selected operation.
----

* *Step 3:* Click the DataMapper element.
----
Expected Result:

Mule automatically prescribes the output of the operation as List<SomeEntity>. The type is in the connector code, for example: PagingDelegate<Map<String, Object>>
for an operation returns: PagingDelegate<Map<String, Object>>
----

* *Step 4:* In the Output Pane select:
.. Type: Map<k,v>
.. Click User Defined
.. Click Generate default
.. Click Create mapping

----
Expected Result:

Mapping involving only the fields being queried is created.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-28.png[]

=== Auto-Paging - DSQL - Pagination is Applied

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector place *Logger* element.
.. Next to the *Logger* put a *For Each* scope.
.. Inside the *For Each* place a DataMapper and then a *Logger* next to it.
.. After the *For Each*, place a *Set Payload* element.
----
Expected Result:

Flow arrangement looks similar to this:
----

image::{imagesdir}/qa-guidelines/qa-guidelines-29.png[]

* *Step 2:*
.. On the connector, select an operation whose return type is PagingDelegate<SomeEntity>.
.. Open Query Builder and generate a simple query such as: SELECT. CreatedById,CreatedDate,Descripti on,OwnerId FROM Account LIMIT 3
.. Set a fetchSize value of 1 or lower than the amount of records being returned.
.. Click Save.
----
Expected Result:
￼
Metadata fetches for the selected operation.
----

* *Step 3:*
.. Set +### Total amount of elements retrieved is
#[message.payload.size()]+ as the
*Logger* message value. Click *Save*.

* *Step 4:* On the DataMapper element creating a mapping to a Default Map<k,v> object.
----
Expected Result:

Mapping creates.
----

* *Step 5:* Set +For element #[flowVars['counter']] payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 6:* Set +Done.+ as the *Set Payload* element Value. Click *Save*.

Example of a complete flow:
[source,xml]
----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>

<flow name="features-autopaging-salesforceFlow1"
doc:name="features-autopaging-salesforceFlow1">

<http:listener config-ref="HTTP_Listener_Configuration" path="apforeach" doc:name="HTTP"/>

 <sfdc:query config-ref="Salesforce"
      query="dsql:SELECT
      CreatedById,CreatedDate,Description,OwnerId
      FROM Account LIMIT 3" doc:name="Query"
      fetchSize="2"/>

  <logger message="### Total amount of
      elements retrieved is
      #[message.payload.size()]" level="INFO"
      doc:name="Size"/>

  <foreach doc:name="For Each">
        <data-mapper:transform
        config-ref="account_to_map" doc:name="Account
        To Map"/>

            <logger message="For element
        #[flowVars['counter']]  payload is
        #[message.payload]" doc:name="Records"/>
        </foreach>

  <set-payload value="Done." doc:name="Set Payload"/>
</flow>
----

* *Step 7:* Run the app and hit the flow endpoint.
* *Step 8:* Look for the messages logged by the Records Logger on the console.
----
Expected Result:

For each record a +For element ... + message was logged displaying its payload.
----

* *Step 9:*  Look for the message of the Size Logger on the console.
----
Expected Result:

Amount of elements retrieved equals number of records returned.
----

=== Auto-Paging - DSQL - Pagination is Not Applied

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

==== Steps

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place *Logger* element.
.. Next to the *Logger*, place a *For Each* scope.
.. Inside the *For Each*, place a DataMapper
and then a *Logger* next to it.
.. After the *For Each*, place a *Set Payload*
element.
----
Expected Result:

Flow arrangement looks similar to this:
----
image::{imagesdir}/qa-guidelines/qa-guidelines-30.png[]

* *Step 2:*
.. On the connector, select an operation whose return type is
PagingDelegate<SomeEntity>.
.. Open Query Builder and generate a simple
query such as: SELECT CreatedById,CreatedDate,Description, OwnerId FROM Account LIMIT 1
.. Set a fetchSize value higher than the amount of records being returned.
.. Click *Save*.
----
Expected Result:

Metadata is fetched for the selected operation.
----

* *Step 3:* Set +### Total amount of elements retrieved is
#[message.payload.size()]+ as the
*Logger* message value. Click *Save*.

* *Step 4:* On the DataMapper element create a mapping to a Default +Map<k,v>+ object.
----
Expected Result:

Mapping creates.
----

* *Step 5:* Set +For element #[flowVars['counter']] payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 6:* Set +Done.+ as the *Set Payload* element Value. Click *Save*.

Example of a complete flow:

[source,xml]
----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>

<flow name="features-autopaging-salesforceFlow1"
doc:name="features-autopaging-salesforceFlow1">

<http:listener config-ref="HTTP_Listener_Configuration" path="apforeach" doc:name="HTTP"/>

  <sfdc:query config-ref="Salesforce"
      query="dsql:SELECT
      CreatedById,CreatedDate,Description,OwnerId
      FROM Account LIMIT 3" doc:name="Query"
      fetchSize="2"/>

  <logger message="### Total amount of
      elements retrieved is
      #[message.payload.size()]" level="INFO"
      doc:name="Size"/>

   <foreach doc:name="For Each">
       <data-mapper:transform
        config-ref="account_to_map" doc:name="Account To Map"/>

       <logger message="For element
        #[flowVars['counter']]  payload is
        #[message.payload]" doc:name="Records"/>
  </foreach>

  <set-payload value="Done." doc:name="Set
  Payload"/>
</flow>
----

* *Step 7:* Run the app and hit the flow endpoint.
* *Step 8:* Look for the messages logged by the Records Logger on the console.
----
Expected Result:

For each record a +For element ... + message was logged displaying its payload.
----

* *Step 9:* Look for the message of the Size Logger on the console.
----
Expected Result:

Amount of elements retrieved equals number of records returned.
Note: You can override the getTotalResults() method in the connector in case of service constraints.
----

=== Native Query Language

=== Auto-Paging - NQL - Auto-Paged Output Handling - DataMapper

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place a DataMapper element.

----
Expected Result:
----

image::{imagesdir}/qa-guidelines/qa-guidelines-31.png[]

* *Step 2:*
.. On the connector select an operation whose return type is PagingDelegate<SomeEntity> and has one of its parameters annotated with @Query.
.. Select Native Query Language as Language.
.. Enter a simple query as Query Text: SELECT
   AccountSource,BillingCity,BillingLon
   gitude,CreatedDate FROM Account
.. As Return type select the same Object as stated in the FROM field of the query.
.. Click Save.
----
Expected Result:

Metadata is fetched for the selected operation.
----

* *Step 3:*
Click the DataMapper element.
----
Expected Result:

Mule automatically prescribes the output of the operation as List<SomeEntity>. The type is in the connector code, for example: PagingDelegate<Map<String, Object>> for an operation returns: PagingDelegate<Map<String, Object>>
----

* *Step 4:* In the Output Pane select:
.. Type: Map<k,v>
.. Click User Defined
.. Click Generate default
.. Click Create mapping
----
Expected Result:

Mapping involving only the fields been queried is created.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-32.png[]

=== Auto-Paging - NQL - Auto-Paged Output Handling - Foreach Combined with DataMapper

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

* *Step 1:* Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place a *For Each* element.
.. Inside the *For Each* place a DataMapper element.

* *Step 2:* On the connector select an operation whose return type is PagingDelegate<SomeEntity> and has one of its parameters annotated with @Query.
.. Select Native Query Language as Language.
.. Enter a simple query as Query Text: SELECT
       AccountSource,BillingCity,BillingLon
       gitude,CreatedDate FROM Account
.. As Return type, select the same Object as stated in the FROM field of the query.
.. Click *Save*.
----
Expected Result:

Metadata is fetched for the selected operation.
----

* *Step 3:*  Click the DataMapper element.
----
Expected Result:

Mule automatically prescribes the output of the operation as List<SomeEntity>. The type is in the connector code, for example: +PagingDelegate<Map<String, Object>>+
for an operation returns: +PagingDelegate<Map<String, Object>>+
----
* *Step 4:*  In the Output Pane select:
.. Type: Map<k,v>
.. Click User Defined
.. Click Generate default
.. Click Create mapping
----
Expected Result:

Mapping involving only the fields been queried is created.
----
image::{imagesdir}/qa-guidelines/qa-guidelines-33.png[]

=== Auto-Paging - NQL - Pagination is Applied

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

* *Step 1:*  Arrange a flow as follows:
.. Place an *HTTP* connector on the canvas.
.. Drop the desired connector in the flow.
.. Next to the connector, place a *Logger* element.
.. Next to the *Logger*, place a *For Each* element.
.. Inside the *For Each*, place a DataMapper and then a *Logger* next to it.
.. After the *For Each*, place a *Set Payload* element.
￼
----
Flow arrangement looks similar to this:
----
image::{imagesdir}/qa-guidelines/qa-guidelines-34.png[]

* *Step 2:*
.. On the connector select an operation whose return type is PagingDelegate<SomeEntity>.
.. Select Native Query Language as Language.
.. Enter a simple query as Query Text: SELECT
   AccountSource,BillingCity,BillingLon
   gitude,CreatedDate FROM Account
.. As Return type select the same Object as stated in the FROM field of the query.
.. Set a fetchSize value of 1 or lower than the amount the amount of records been returned.
.. Click Save.
----
Expected Result:

Metadata is fetched for the selected operation.
----

* *Step 3:* Set +### Total amount of elements retrieved is
#[message.payload.size()]+ as the
*Logger* message value. Click *Save*.

* *Step 4:*  On the DataMapper element creating a mapping to a Default Map<k,v> object.
----
Expected Result:

Mapping is created.
----

* *Step 5:* Set +For element #[flowVars['counter']] payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 6:* Set +Done.+ as the *Set Payload* element Value. Click *Save*.

* *Step 7:* Run the app and hit the flow endpoint.

* *Step 8:*   Look for the messages logged by the Records Logger on the console.
----
Expected Result:

For each record a +For element ... + message was logged displaying its payload.
----

* *Step 9:* Look for the message of the Size Logger on the console.
----
Expected Result:

Amount of elements retrieved equals number of records returned.
----

=== Auto-Paging - NQL - Pagination is Not Applied

==== Preconditions

* Global Configuration element was already created with valid credentials to the service.

* *Step 1:* Arrange a flow as follows:
.. In Studio, place an *HTTP* connector on the canvas.
.. Place a connector in the flow.
.. Next to the connector, place a *Logger* element.
.. Next to the *Logger*, place a *For Each* element.
.. Inside the *For Each*, place a *DataMapper* and then a *Logger* next to it.
.. After the *For Each*, place a *Set Payload* element.
----
Flow arrangement looks similar to this:

----
image::{imagesdir}/qa-guidelines/qa-guidelines-35.png[]


* *Step 2:*
.. For your connector, select an operation whose return type is +PagingDelegate<SomeEntity>+.
Metadata fetches for the selected operation.
.. Open Query Builder and generate a simple query such as: +SELECT CreatedById,CreatedDate,Description,OwnerId FROM Account LIMIT 1+
.. Set a fetchSize value higher than the number of records that have been returned.
.. Click *Save*.


* *Step 3:* Set +### Amount of elements retrieved is #[message.payload.size()]+ as the
*Logger* message value. Click *Save*.


* *Step 4:*  On the DataMapper element create a mapping to a Default +Map<k,v>+ object.

----
Expected Result:

Mapping is created.
----


* *Step 5:* Set +For element #[flowVars['counter']] payload is #[message.payload]+ as the *Logger* message value. Click *Save*.

* *Step 6:* Set +Done.+ as the *Set Payload* element Value. Click *Save*.

Example of a complete flow:

[source,xml]
----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>

<flow name="features-autopaging-salesforceFlow3"
doc:name="features-autopaging-salesforceFlow3">

<http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP"/>

    <sfdc:query config-ref="Salesforce"
  query="SELECT
  AccountSource,BillingCity,BillingLongitude,CratedDate
  FROM Account" doc:name="Salesforce"/>

  <logger message="### Total amount of elements retrieved is
  #[message.payload.size()]" level="INFO"
  doc:name="Size"/>

    <foreach doc:name="For Each">
      <data-mapper:transform
    config-ref="account_to_map_1"
    doc:name="Account To Map"/>

      <logger message="For element
    #[flowVars['counter']]  payload is
    #[message.payload]" doc:name="Records"/>
  </foreach>
  <set-payload value="Done." doc:name="Set Payload"/>
</flow>
----

* *Step 7:* Run the app and hit the flow endpoint.

* *Step 8:* Look for the messages logged by the Records Logger on the console.
----
Expected Result:

For each record a +For element ... + message was logged displaying its payload.
----


* *Step 9:* Look for the message of the Size Logger on the console.
----
Expected Result:

Amount of elements retrieved equals number of records returned.
Note: You can override the getTotalResults() method in the connector in case of service constraints.
----
