== Jenkins
=== How to create an automatic testing build for a connector

. The MuleSoft Jenkins CloudBees https://muleion.ci.cloudbees.com/[hosted page] requests a username and password to access the system. If not available, contact someone in charge of the Anypoint Connectors certification program.

image::{imagesdir}/cloudbees-1.png[]

. This page list the builds already created. To create a new one, select the view where you want to put your build. There is an exclusive view for our connectors called *anypoint-connectors-certification*. Select it, and once inside the view, you can see the rest of the connector builds.

image::{imagesdir}/cloudbees-2.png[]

. Select *New Item* label which is located on the left of the website, to be redirected to the new job editor page. 
You need to configure two things: The Item Name, which is the name of your Connector Build Following the Naming Convention, and the type of build--use the Build a maven project type. 
Click the OK button to complete creating your connector build. 
(After creating the connector build, Jenkins redirects you to the Build Configuration).

image::{imagesdir}/cloudbees-3.png[]

== Connector Builds in Jenkins

=== For each connector, create 3 different builds:


* Automatic testing for master branch
* Automatic testing for develop branch
* Snapshot deploy branch


=== Configure automatic testing build for master branch

. To access to the Build Configuration, go back to the anypoint-connectors-certification view and select the build you want to configure.
. Select the Configure label, which is located on the left of the website to access the Build Configuration.
. Inside the Build are several blocks of configurations, the most important is described below with instructions on what to do in each one.



* *CloudBees DEV@cloud Authorization*: On the GitHub Project TextBox, complete it with the GitHub repository URL.

* *Slack Notifications*: Project Channel: #connectors-cert-bot And check: 
** Notify Failure 
** Notify Not Built 
** Notify Success
** Notify Unstable 

* *Source Code Management*: For the moment we are only going to use GitHub: 
** Check the Git radio button and a form displays. 
** In Repository URL in the same way as before, complete it with the GitHub repository URL. (If any error is displayed, please read the GitHub troubleshoot in the Appendix)  

* *Build Triggers*: The build triggers have the functionality to configure how often or against which events we want build the connector. By default, Jenkins selects *Build whenever a SNAPSHOT dependency is built*, but for Connectors uncheck this option.
** *Build periodically*: Inside the Schedule text box, you can configure how often, or at particular times of day you want to build the project, just put “@midnight” in the schedule.
** *Build when a change is pushed to GitHub (For develop branches)*: By checking this you allow Jenkins to build the project after every commit. This is needed to configure GitHub to notify Jenkins that a new Commit has been pushed. 
To do this, go to the *GitHub repository web page → Settings → WebHooks/Services*.  

	If in the first case you don’t see Settings option in the right column or the repository web page shows a 404 error, it means you don’t have permission to do this 

** On the WebHooks/Service page:
*** Click Add Service and search and click “Jenkins (GitHub plugin)”
*** The service prompts you for a Jenkins hook URL. Use: https://muleion.ci.cloudbees.com/github-webhook/. 
*** Click the Active checkbox.
*** Click Add Service. 

* *Pre Steps*: Indicate the steps to do in the previous main Maven build step.
** Retrieve testing credentials. Execute shell example
	
	export URL="https://automationcreds.s3.amazonaws.com/myconnectr-automation.properties?AWSAccessKeyId=SomeKey&Expires=SomeExpiration&Signature=SomeSignature" && curl ${URL} -o src/test/resources/connectorexample.properties

	if you don't have the credentials to the signed link, please request them from the Anypoint Connector Certification Program. Contact Mariano Quintela (mariano.quintela@mulesoft.com) or Paulo Veiga (paulo.veiga@mulesoft.com).

* *Build*: This is the main build step where you define the compilation Maven goals and options.
** Maven Version: 3.0.4
** Root POM: Keep pom.xml file
** Goals and options: ```clean org.jacoco:jacoco-maven-plugin:prepare-agent install -Dtest=RegressionTestSuite -Dmule.test.timeoutSecs=180 -Dmule.testingMode=true -U```
** Advanced: If a credentials file is needed to be passed like an argunment add it like a MAVEN_OPTS
Example: *“-DCONNECTOREXAMPLE_CREDENTIALS=connectorexample.properties”*

* *Post Steps*:
** Click Run regardless of build result to ensure that these steps execute regardless of the test result. 
** Click Add post-step build.
** Click Invoke top-level maven target. Goals: sonar:sonar 
** Click Advance.
** Configure the Settings File option with the provided Settings.xml file.
** Click SettingsForConnectors.

* *Build Settings*: Configure email notifications for failed and unstable builds.
* *Post Build Actions*: Add post-build action → Slack Notifications

After you finish the build configuration, click Save to save all new configurations. To verify that all settings are ​​correct, click Build Now and wait for Build Result.

=== Create a Build for SNAPSHOT Deployment
To configure a build for *snapshot deployment*, and after you configure the development and master branch builds for the connector, go back to the *anypoint-connectors-certification* view, go inside it, and select *new item*. 
In the *New Item* menu, you can can create the new build in two ways:
. The easiest one is to check the Copy existing Item option and write the name of the develop branch build of your connector.

image::{imagesdir}/cloudbees-6.png[]

. Create a new one from the ground.

Important: The name for this build plan must follow the snapshot build name convention (which is explained in the appendix)

After you create the deployment build with all the basic configurations, follow these steps to make changes:

. Make sure that the selected Git branch is develop.
. Set the build trigger only with Build periodically, with @midnight frequency.
. Change the main Maven build step to “clean deploy -U”.
. In the main Maven build step:
.. Click the Advance... button.
.. Look for Settings file option, and choose provided settings.xml, another dropdown displays asking for the Provided Settings.
.. Choose SettingsForConnectors:

image::{imagesdir}/cloudbees-7.png[]

. Finish the configuration, save it, and verify that all settings are ​​correct. 
. Click Build Now and wait for the Build Result.


== SonarQube
=== What is SonarQube?

SonarQube is an open source platform for Continuous Inspection of code quality. Use this tool to automatically check the code to ensure your service has a quality user experience.

Finishing SonarQube configuration


. If you correctly configure the sonar:sonar step in your Develop branch and run it, the SonarQube project in your connector creates a SonarQube instance https://muleion.sonar.cloudbees.com/. Select your project from this web page.
. In the opened panel, we see lots of information as the result of analysis of our connector, such as the number of issues, types of issues, test coverage, code lines total, etc. All this analysis results from a Anypoint Connectors Certification Quality Profile with code analytics rules designed for connector codes. These rules could be Java rules like: 
Declarations should use Java collection interfaces such as "List" rather than specific implementation classes such as LinkedList
Or coding style rules like:
Right curly braces should be located at the beginning of lines of code

image::{imagesdir}/cloudbees-8.png[]


. To ensure you use the Anypoint Connectors Certification Quality Profile, click the Configurations label located in the top right of the web page. When clicked, a list of options displays, and you should select Quality Profiles. 
. Once inside, select from the Quality Profile selector the Anypoint Connectors Certification, and finish clicking the Update Button.

image::{imagesdir}/cloudbees-9.png[]


These steps configure SonarQube to analyse the connector code after each build.

=== Excluding Files and Directories from SonarQube Analysis 
In case SonarQube results aren’t relevant, it's important to configure the project to avoid noise, such as issues on generated code or issues that aren’t relevant to the current analysis.

. To configure the exclusion of files and directories, go back to the *Configuration* menu of the build configured with *Sonar*, and go to the __sonar:sonar__ step.
	
	image::{imagesdir}/cloudbees-10.png[]


. With the *“-Dsonar.exlusions=”* parameter, you can specify the files and directories to exclude by adding a parameter, followed by the directories and a file path, and these patterns:
	
|===
| Wildcard | Matches 

|*	|0 or more characters
|**	|0 or more directories
|?	|a single character
|===


|===
|Examples|-Dsonar.exclusions=

|Exclude generated sources|  \\**/generated-sources/**
|Exclude all classes in a directory|src/main/java/org/somePackage/*.java
|To add more than one exclusion, separate each with a comma.| src/main/java/org/somePackage/\*.java,** /*Bean.java
|===

For more information on how to narrow analysis focus, see the http://docs.codehaus.org/display/SONAR/Narrowing+the+Focus[SonarQube documentation].

== Appendix
=== Errors
==== GitHub private repositories 

If a repository is private, this error displays:

```
Failed to connect to repository: 
Failed to connect to https://github.com/{account-name}/{repository-name}(status = 401)
```

This error occurs because Jenkins is unable to access the described repository because it lacks credentials. To fix this, select from the **Credentials** and the **devkitdoc** credentials.

If the problem persists, create a new repository by clicking the __Add__ button.

Complete the **Add Credentials** window with these values:
* Kind: Username with a password
* Username: GitHub username
* Password: GitHub password
* Description: Describe the purpose of these credentials


Click *Add* and select the new credentials from the selector. If everything is correctly configured, the error no longer occurs.

==== Maven not authorized to collect dependencies
In case of a *Build Failure* due a lack of credentials to download dependencies, you need to configure all the Maven steps with a provided __Settings.xml__ file to grant access to the repositories.

. Go to the connector build configuration panel.
. Look for the maven step that produce the build failure.
. Click the Advance... button, look for the Settings file option, and choose provided settings.xml. Another drop-down displays that prompts for the Provided Settings. Choose SettingsForConnectors.

image::{imagesdir}/cloudbees-7.png[]

. Build the project and verify that the error does no longer occurs.


NOTE: If a connector project requires a special *settings.xml* file, make a request to the MuleSoft Certification Program to request that the file be uploaded.


=== Conventions
==== Automation Build Name


The build name must comply with the following characteristics: 
. The place name has to be whole words.
. No abbreviations.
. Each word must be separated by a hyphen.
. The name must end with the word connector followed by the repository branch name that is being used in the build.
. You can use this regular expression: * ([a-zA-Z0-9]*-?)*-connector-test-[a-zA-Z]* *
	* Example for the Slack Connector
	```
	slack-connector-test-develop
	```

==== Snapshot Deployment Build Name

The build name must comply with the following characteristics: 
. The place name has to be whole words.
. No abbreviations.
. Each word must be separated by a hyphen.
. The name must end with the word connector-deploy.
. You can use this regular expression: * ([a-zA-Z0-9]*-?)*-connector-deploy *
	* Example for the Slack Connector
	```
	slack-connector-deploy
	```